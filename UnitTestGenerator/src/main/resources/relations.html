<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diagrama Interactivo</title>
    <style>
        body {
            margin: 0;
            overflow: hidden;
        }

        #container {
            position: relative;
            width: 100vw;
            height: 100vh;
            overflow: scroll;
            background-color: #222;
        }

        #linesCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .element {
            position: absolute;
            width: 120px;
            height: 80px;
            background: white;
            border: 2px solid black;
            cursor: grab;
            padding: 10px;
            text-align: center;
            font-family: Arial, sans-serif;
        }

        .popup {
            position: absolute;
            background: white;
            border: 2px solid black;
            padding: 10px;
            z-index: 1000;
            min-width: 150px;
        }

        .popup hr {
            margin: 5px 0;
        }

        /* .popup button { display: block; width: 100%; margin-top: 5px; } */
        .popup button {
            display: block;
            width: 100%;
            margin-top: 5px;
            position: absolute;
            bottom: 0;
            left: 0;
        }

        /* button { position: absolute; top: 10px; left: 10px; z-index: 1000; } */
    </style>
</head>

<body>
<div id="container">
    <canvas id="linesCanvas"></canvas>
    <div id="elements"></div>
</div>
<script>
    const container = document.getElementById("container");
    const elementsDiv = document.getElementById("elements");
    const canvas = document.getElementById("linesCanvas");
    const ctx = canvas.getContext("2d");
    let elements = [];


    const predefinedElements = [
        { name: "Inicio", valor: "A", variables: ["var1", "var2"], metodos: ["met1"], conste: [{ conexion: "Proceso", move: false }, { conexion: "Fin", move: false }] },
        { name: "Proceso", valor: "B", variables: ["data", "count"], metodos: ["process", "validate"], conste: [{ conexion: "Decisión", move: true }] },
        { name: "Decisión", valor: "C", variables: ["flag"], metodos: ["checkCondition"], conste: [{ conexion: "Fin", move: false }, { conexion: "Proceso", move: false }] },
        { name: "Fin", valor: "D", variables: [], metodos: [], conste: [] }
    ];


    function createElement(x, y, name, valor, id, conste, variables, metodos) {
        const element = document.createElement("div");
        element.classList.add("element");
        element.style.left = `${x}px`;
        element.style.top = `${y}px`;
        element.innerHTML = `<strong>${name}</strong><br>Valor: ${valor}`;
        element.dataset.id = id;
        elementsDiv.appendChild(element);

        // Añadir propiedad popup al elemento
        elements.push({ id, element, x, y, conste, variables, metodos, popup: null });

        element.addEventListener("click", function (e) {
            if (this.dataset.dragged === "true") { // Verificar si hubo arrastre
                this.dataset.dragged = "false"; // Resetear bandera
                return;
            }
            showPopup(id);
        });
        makeDraggable(element);
    }



    function makeDraggable(element) {
        let offsetX, offsetY, isDragging = false;

        element.addEventListener("mousedown", (e) => {
            isDragging = true;
            element.dataset.dragged = "false";
            offsetX = e.clientX - element.offsetLeft;
            offsetY = e.clientY - element.offsetTop;
            e.stopPropagation();
        });

        document.addEventListener("mousemove", (e) => {
            if (!isDragging) return;
            element.dataset.dragged = "true";
            element.style.left = `${e.clientX - offsetX}px`;
            element.style.top = `${e.clientY - offsetY}px`;
            updateConnections();
            e.preventDefault();
        });

        document.addEventListener("mouseup", () => {
            isDragging = false;
        });
    }

    function showPopup(id) {
        const element = elements.find(e => e.id === id);
        if (!element || element.popup) return;  // Si ya tiene popup, no hacer nada

        let popup = document.createElement("div");
        popup.classList.add("popup");
        popup.style.left = `${element.element.offsetLeft + 140}px`;
        popup.style.top = `${element.element.offsetTop}px`;

        popup.innerHTML = `<strong>${element.element.innerText.split('\n')[0]}</strong>`;
        popup.innerHTML += `<hr>`;
        popup.innerHTML += `<p><strong>Variables:</strong></p>`;
        element.variables.forEach(v => popup.innerHTML += `<p>${v}</p>`);
        popup.innerHTML += `<hr>`;
        popup.innerHTML += `<p><strong>Métodos:</strong></p>`;
        element.metodos.forEach(m => popup.innerHTML += `<p>${m}()</p>`);
        popup.innerHTML += `<hr>`;

        let closeButton = document.createElement("button");
        closeButton.innerText = "Cerrar";

        closeButton.addEventListener("click", () => {
            popup.remove();
            element.popup = null;  // Eliminar referencia al cerrar
        });
        popup.appendChild(closeButton);
        document.body.appendChild(popup);
        element.popup = popup;
    }


    function updateConnections() {
        canvas.width = container.clientWidth;
        canvas.height = container.clientHeight;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        ctx.strokeStyle = "white";
        ctx.lineWidth = 2;

        elements.forEach(({ id, conste }) => {
            const fromElement = elements.find(e => e.id === id)?.element;
            if (!fromElement) return;

            conste.forEach(({ conexion, move }) => {
                const toElement = elements.find(e => e.element.innerText.includes(conexion))?.element;

                if (!toElement) return;

                const x1 = fromElement.offsetLeft + fromElement.clientWidth / 2;
                const y1 = fromElement.offsetTop + fromElement.clientHeight / 2;
                const x2 = toElement.offsetLeft + toElement.clientWidth / 2;
                const y2 = toElement.offsetTop + toElement.clientHeight / 2;

                ctx.beginPath();
                ctx.moveTo(x1, y1);
                ctx.lineTo(x2, y2);
                ctx.stroke();

                const middleX = (x1 + x2) / 2;
                const middleY = (y1 + y2) / 2;

                if (move) {
                    // Flecha azul en el medio de la línea
                    ctx.fillStyle = "blue";
                    ctx.beginPath();
                    ctx.moveTo(middleX - 10, middleY - 5);
                    ctx.lineTo(middleX + 10, middleY - 5);
                    ctx.lineTo(middleX, middleY + 10);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    // Cuadro rojo en el medio de la línea
                    ctx.fillStyle = "red";
                    ctx.fillRect(middleX - 5, middleY - 5, 10, 10);
                }
            });
        });
    }


    predefinedElements.forEach((el, index) => {
        createElement(100 + index * 150, 100, el.name, el.valor, index, el.conste, el.variables, el.metodos);
    });
</script>
</body>

</html>